/*! random-movie-trailer 2017-10-17 */

function errorMsg(e){return"Error: "+e+' Click <a href=".">here</a> to refresh the page.'}const express=require("express"),router=express.Router(),movieTrailer=require("movie-trailer"),fs=require("fs"),path=require("path"),request=require("request");var debug="test"!=process.env.NODE_ENV;const random=require(path.join(__dirname,"../lib/random")),isArray=require("../lib/is-array");router.get("/",(e,o)=>{debug&&console.log("Page requested!"),debug&&console.log("Cookies: ",e.cookies);var r;const i=r=>new Promise((i,n)=>{let t,s;if(1==r.length)movie=r[0],movie.letterboxd=movie.title.replace(/\s+/g,"-").toLowerCase(),i(movie);else{if(e.cookies.randomInt){let i=e.cookies.randomInt,n="string"==typeof i?JSON.parse(i):i;s=random.exclude(0,r.length-1,n,debug),n.push(s),o.cookie("randomInt",n)}else s=[random.exclude(0,r.length-1,[0],debug)],o.cookie("randomInt",JSON.stringify(s));(t=r[s]).index=s,t.letterboxd=t.title.replace(/\s+/g,"-").toLowerCase(),i(t)}}),n=e=>new Promise((o,r)=>{movieTrailer(e.title,(i,n)=>{debug&&console.log("Requesting trailer for: ",e.title," with index ",e.index),i?r(i):(e.videoID=n.slice(32,n.length),debug&&console.log("Video ID: ",e.videoID),o(e))})}),t=e=>{console.log("renderMovie(finalMovie) ",e),o.render("main",e,(r,i)=>{r&&reject(r),debug&&console.log("Final movie:",e),debug&&console.log("Rendering..."),o.send(i),debug&&console.log("Done!")})},s=e=>{console.log("selectMovie() called"),i(e).then(n).catch(e=>{if("Got error: No results found"==e)throw s(r),new Error(e)}).then(t).catch(e=>console.error(e))};(e=>new Promise((o,i)=>{fs.readFile(e,(e,n)=>{e&&i(e),r=JSON.parse(n),console.log("File read"),o(r)})}))(path.join(__dirname,"../models/movies.json")).then(o=>new Promise((r,i)=>{const n=Object.keys(e.query).length;if(console.log("Parsing ",n,"queries"),n>0){if(e.query.index&&e.query.trailer)i("You can't call two parameters at once.");else if(e.query.index){var t=Number(e.query.index);console.log("Calling index ",t),t<o.length&&t>=0?(movie=o[t],movie.index=t):i(errorMsg("Index is not a number or it's out of range.")),console.log("Requested: ",movie)}else e.query.trailer&&(movie={title:e.query.trailer});r([movie])}r(o)})).catch(e=>console.error(e)).then(s)}),module.exports=router;
