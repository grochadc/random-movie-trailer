/*! random-movie-trailer 2017-10-14 */

function errorMsg(e){return"Error: "+e+' Click <a href=".">here</a> to refresh the page.'}var express=require("express"),router=express.Router(),movieTrailer=require("movie-trailer"),fs=require("fs"),path=require("path"),request=require("request"),debug="test"!=process.env.NODE_ENV,random=require("../lib/random");router.get("/",(e,r)=>{debug&&console.log("Page requested!"),debug&&console.log("Cookies: ",e.cookies);(e=>new Promise((r,o)=>{fs.readFile(e,(e,s)=>{e&&o(e);var t=JSON.parse(s);r(t)})}))(path.join(__dirname,"../models/movies.json")).then(o=>new Promise((s,t)=>{var i;if(Object.keys(e.query).length>0)if(e.query.index&&e.query.trailer&&r.send(errorMsg("You can't call two parameters at once.")),e.query.index){var n=Number(e.query.index);(n||0==n)&&n<o.length&&n>=0?i={title:o[n].title,imdbID:o[n].imdbID,criticsScore:o[n].criticsScore,usersScore:o[n].usersScore}:t(errorMsg("Index is not a number or it's out of range."))}else e.query.trailer&&(i={title:e.query.trailer});else{var l;if(e.cookies.randomInt){var a=e.cookies.randomInt,u="string"==typeof a?JSON.parse(a):a;l=random.exclude(0,o.length-1,u,debug),u.push(l),r.cookie("randomInt",u)}else l=[random.exclude(0,o.length-1,[0],debug)],r.cookie("randomInt",JSON.stringify(l));(i=o[l]).index=l,s(i)}})).catch(e=>r.status(500).send(errorMsg(e))).then(e=>new Promise((o,s)=>{movieTrailer(e.title,(o,t)=>{if(debug&&console.log("Requesting trailer for: ",e.title," with index ",e.index),o)s(errorMsg(o));else{var i=t.replace("watch?v=","embed/");debug&&console.log("Video ID: ",t.slice(32,t.length)),e.videoID=t.slice(32,t.length),e.trailerURL=i,r.render("main",e,(o,s)=>{o&&rject(o),debug&&console.log("Rendering..."),debug&&console.log(e),r.send(s),debug&&console.log("Done!")})}})})).catch(e=>r.status(500).send(errorMsg(e)))}),module.exports=router;