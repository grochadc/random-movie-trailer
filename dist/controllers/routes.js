/*! random-movie-trailer 2017-10-16 */

function errorMsg(e){return"Error: "+e+' Click <a href=".">here</a> to refresh the page.'}var express=require("express"),router=express.Router(),movieTrailer=require("movie-trailer"),fs=require("fs"),path=require("path"),request=require("request"),debug="test"!=process.env.NODE_ENV,random=require(path.join(__dirname,"../lib/random"));const isArray=require("../lib/is-array");router.get("/",(e,r)=>{debug&&console.log("Page requested!"),debug&&console.log("Cookies: ",e.cookies);var o,i=o=>new Promise((i,n)=>{var t,s;if(1==o.length)movie=o[0],movie.letterboxd=movie.title.replace(/\s+/g,"-").toLowerCase(),i(movie);else{if(e.cookies.randomInt){var l=e.cookies.randomInt,a="string"==typeof l?JSON.parse(l):l;s=random.exclude(0,o.length-1,a,debug),a.push(s),r.cookie("randomInt",a)}else s=[random.exclude(0,o.length-1,[0],debug)],r.cookie("randomInt",JSON.stringify(s));(t=o[s]).index=s,t.letterboxd=t.title.replace(/\s+/g,"-").toLowerCase(),i(t)}}),n=e=>new Promise((r,o)=>{movieTrailer(e.title,(i,n)=>{debug&&console.log("Requesting trailer for: ",e.title," with index ",e.index),i?o(i):(e.videoID=n.slice(32,n.length),debug&&console.log("Video ID: ",e.videoID),r(e))})}),t=e=>{console.log("renderMovie(finalMovie) ",e),r.render("main",e,(o,i)=>{o&&reject(o),debug&&console.log("Final movie:",e),debug&&console.log("Rendering..."),r.send(i),debug&&console.log("Done!")})},s=()=>{console.log("selectMovie() called"),i(o).then(n).catch(e=>{if("Got error: No results found"==e)throw new Error(e)}).then(t).catch(e=>console.error(e))};(e=>new Promise((r,i)=>{fs.readFile(e,(e,n)=>{e&&i(e),o=JSON.parse(n),console.log("File read"),r(o)})}))(path.join(__dirname,"../models/movies.json")).then(r=>new Promise((o,i)=>{const n=Object.keys(e.query).length;if(console.log("Parsing ",n,"queries"),n>0){if(e.query.index&&e.query.trailer)i("You can't call two parameters at once.");else if(e.query.index){var t=Number(e.query.index);console.log("Calling index ",t),t<r.length&&t>=0?(movie=r[t],movie.index=t):i(errorMsg("Index is not a number or it's out of range.")),console.log("Requested: ",movie)}else e.query.trailer&&(movie={title:e.query.trailer});o([movie])}o(r)})).catch(e=>console.error(e)).then(i).catch(e=>console.error(e)).then(n).catch(e=>{if("Got error: No results found"==e)throw s(),new Error(e)}).then(t).catch(e=>console.error(e))}),module.exports=router;