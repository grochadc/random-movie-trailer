/*! random-movie-trailer 2017-10-15 */

function errorMsg(e){return"Error: "+e+' Click <a href=".">here</a> to refresh the page.'}var express=require("express"),router=express.Router(),movieTrailer=require("movie-trailer"),fs=require("fs"),path=require("path"),request=require("request"),debug="test"!=process.env.NODE_ENV,random=require(path.join(__dirname,"../lib/random"));const isArray=require("../lib/is-array");router.get("/",(e,o)=>{debug&&console.log("Page requested!"),debug&&console.log("Cookies: ",e.cookies);var r,n=r=>new Promise((n,i)=>{var s,t;if(!isArray(r)){console.log("Movies is an obj");var l=Object.keys(r)[0];console.log("Movies firstEl is ",l),console.log("Is title? ",Boolean("title"==l),"Is elements? ",Boolean("elements"==l)),"title"==l?n(s=r):"elements"==l&&(found=r.found,r=r.elements,found||(e.query={}))}if(e.cookies.randomInt){var a=e.cookies.randomInt,c="string"==typeof a?JSON.parse(a):a;t=random.exclude(0,r.length-1,c,debug),c.push(t),o.cookie("randomInt",c)}else t=[random.exclude(0,r.length-1,[0],debug)],o.cookie("randomInt",JSON.stringify(t));s=r[t],console.log("randomMovie ",s),s.index=t,s.letterboxd=s.title.replace(/\s+/g,"-").toLowerCase(),n(s)}),i=e=>new Promise((o,r)=>{movieTrailer(e.title,(n,i)=>{debug&&console.log("Requesting trailer for: ",e.title," with index ",e.index),n?r(n):(e.videoID=i.slice(32,i.length),debug&&console.log("Video ID: ",i.slice(32,i.length)),console.log("requestTrailer resolving ",e),o(e))})}),s=e=>{console.log("renderMovie(finalMovie) ",e),o.render("main",e,(r,n)=>{r&&reject(r),debug&&console.log("Final movie:",e),debug&&console.log("Rendering..."),o.send(n),debug&&console.log("Done!")})},t=e=>{console.log("selectMovie() called"),n({elements:r,found:!1}).then(i).catch(e=>{if("Got error: No results found"==e)throw new Error(e)}).then(s).catch(e=>console.error(e))};(e=>new Promise((o,n)=>{fs.readFile(e,(e,i)=>{e&&n(e),r=JSON.parse(i),console.log("File read"),o(r)})}))(path.join(__dirname,"../models/movies.json")).then(o=>new Promise((r,n)=>{const i=Object.keys(e.query).length;if(console.log("Parsing ",i,"queries"),i>0){if(e.query.index&&e.query.trailer&&n("You can't call two parameters at once."),e.query.index){var s=Number(e.query.index);console.log("Calling index ",s),(s||0==s)&&s<o.length&&s>=0?randomMovie={title:o[s].title,imdbID:o[s].imdbID,criticsScore:o[s].criticsScore,usersScore:o[s].usersScore,index:s}:n(errorMsg("Index is not a number or it's out of range.")),console.log("Requested: ",randomMovie)}e.query.trailer?randomMovie={title:e.query.trailer}:r(randomMovie)}r(o)})).catch(e=>console.error(e)).then(n).catch(e=>console.error(e)).then(i).catch(e=>{if("Got error: No results found"==e)throw t(),new Error(e)}).then(s).catch(e=>console.error(e))}),module.exports=router;