/*! random-movie-trailer 2017-10-19 */

function errorify(e){return e+=" Selecting a random movie.",new Error(e)}const express=require("express"),router=express.Router(),movieTrailer=require("movie-trailer"),request=require("request"),path=require("path"),fs=require("fs");var debug="test"!=process.env.NODE_ENV;const random=require(path.join(__dirname,"../lib/random")),isArray=require("../lib/is-array");router.get("/",(e,o)=>{debug&&console.log("Page requested!"),debug&&console.log("Cookies: ",e.cookies);const r=r=>new Promise((i,n)=>{let t,s;if(1==r.length)movie=r[0],movie.letterboxd=movie.title.replace(/\s+/g,"-").toLowerCase(),i(movie);else{if(e.cookies.randomInt){let i=e.cookies.randomInt,n="string"==typeof i?JSON.parse(i):i;s=random.exclude(0,r.length-1,n,debug),n.push(s),o.cookie("randomInt",n)}else s=[random.exclude(0,r.length-1,[0],debug)],o.cookie("randomInt",JSON.stringify(s));(t=r[s]).index=s,t.letterboxd=t.title.replace(/\s+/g,"-").toLowerCase(),i(t)}}),i=e=>new Promise((o,r)=>{movieTrailer(e.title,(i,n)=>{debug&&console.log("Requesting trailer for: ",e.title," with index ",e.index),i?r(i):(e.videoID=n.slice(32,n.length),debug&&console.log("Video ID: ",e.videoID),o(e))})}),n=e=>{o.render("main",e,(r,i)=>{r&&reject(r),debug&&console.log("Final movie:",e),debug&&console.log("Rendering..."),o.send(i),debug&&console.log("Done!")})},t=e=>{debug&&console.log("selectMovie() called"),e.msg&&(debug&&console.log("Index :",e.index),debug&&console.error(errorify(e.msg)),e=[e.movie]),r(e).then(i).catch(e=>{if("Got error: No results found"==e)throw t(moviesDB),new Error(e)}).then(n).catch(e=>console.error(e))};(e=>new Promise((o,r)=>{fs.readFile(e,(e,i)=>{e&&r(e),moviesDB=JSON.parse(i),debug&&console.log("File read"),o(moviesDB)})}))(path.join(__dirname,"../models/movies.json")).then(o=>new Promise((r,i)=>{const n=Object.keys(e.query).length;if(debug&&console.log("Parsing ",n,"queries"),n>0){if(e.query.index&&e.query.trailer)i(errorify("You can't call two parameters at once."));else if(e.query.index){var t=Number(e.query.index);if(debug&&console.log("Calling index ",t),t<o.length&&t>=0)movie=o[t],movie.index=t;else if(isNaN(t)||t<=0||t>o.length){let e=random.exclude(0,o.length-1);movie=o[e],r({msg:"Index is not a number or it's out of range.",movie:movie,index:e})}debug&&console.log("Requested: ",movie.title)}else e.query.trailer&&(movie={title:e.query.trailer});r([movie])}else r(o)})).then(t).catch(e=>console.error(e))}),module.exports=router;